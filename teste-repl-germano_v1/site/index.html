<!DOCTYPE html>
<html>

<head>
    <title>Syntax Highlight SQL</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/theme/darcula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/theme/ayu-mirage.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="loader.css">
    <link rel="stylesheet" href="loader2.css">
    <link rel="stylesheet" href="layout.css">
    <link rel="stylesheet" href="buttons.css">
    <link rel="stylesheet" href="scrollbar.css">
    <link rel="stylesheet" href="compile-log.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/hint/sql-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/hint/show-hint.min.js"></script>
</head>

<body>


    <div class="stylized-box">
        <section class="horizontal-items">
            <div class="stylized-card horizontal-items">
                <div id="anime-character" class="image-container"></div>
                <textarea id="dialog-box" class="feedback">
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                </textarea>
            </div>
        </section>
        <section class="horizontal-items">
            <section class="vertical-items ">
                <h1>ENTRADA JSON</h1>
                <textarea id="inputJsonTextArea" class="json">{"key": "valueX"}</textarea>
            </section>
            <section class="vertical-items ">
                <h1>ESQL</h1>
                <textarea id="sqlTextArea" class="">
CREATE COMPUTE MODULE main_msgflow_Compute
    CREATE FUNCTION Main() RETURNS BOOLEAN
    BEGIN
        CALL CopyEntireMessage();
        RETURN TRUE;
    END;
    
    CREATE PROCEDURE CopyEntireMessage() BEGIN
        SET OutputRoot = InputRoot;
    END;
END MODULE;
                </textarea>
                <section class=" centered-spaced-items">
                    <button id="connectbtn" class="bn5" onclick="openWebSocket()">Conectar Servidor</button>
                    <button class="bn5" onclick="compileESQl()">Compilar ESQL</button>
                    <button class="bn5" onclick="enviarJSON()">Enviar JSON</button>
                </section>
                <h2>ConexÃ£o</h2>
                <div id="compile-log" class="">
                    <div class="compile-log success-compile-log"> Clique no botÃ£o "Compilar"</div>
                    <div class="compile-log error-compile-log"> Mas certifique-se de ter subido o servidor ðŸ˜‰ </div>
                </div>
            </section>
            <section class="vertical-items ">
                <h1>SAIDA JSON</h1>
                <textarea id="outputJsonTextArea" class="json" disabled>{"key": "valueY"}</textarea>
                <div id="httpStatusCode">Status code: ___</div>
                <h2>ConexÃ£o</h2>
                <div id="compile-log" class="stylized-box">
                    <div class="compile-log success-compile-log"> Clique no botÃ£o "Compilar"</div>
                    <div class="compile-log error-compile-log"> Mas certifique-se de ter subido o servidor ðŸ˜‰ </div>
                </div>
            </section>
        </section>
    </div>

    <script>
        ////////////////////////////////////////////////////////////////////////////////////
        var esqlTextArea = CodeMirror.fromTextArea(
            document.getElementById("sqlTextArea"), {
            mode: "text/x-pgsql",
            //            theme: "monokai",
            theme: "ayu-mirage",
            lineNumbers: true,
            matchBrackets: true,
            autoCloseBrackets: true,
            extraKeys: { "Ctrl-Space": "autocomplete" }
        });
        //esqlTextArea.setSize("100vw","100vh");
        esqlTextArea.setSize("40vw", '80vh');
        var inputJsonTextArea = CodeMirror.fromTextArea(
            document.getElementById("inputJsonTextArea"), {
            mode: "application/json",
            theme: "ayu-mirage",
            lineNumbers: true,
            matchBrackets: true,
            autoCloseBrackets: true,
            extraKeys: { "Ctrl-Space": "autocomplete" }
        });
        inputJsonTextArea.setSize("25vw", "80vh");
        var outputJsonTextArea = CodeMirror.fromTextArea(
            document.getElementById("outputJsonTextArea"), {
            mode: "application/json",
            theme: "ayu-mirage",
            lineNumbers: true,
            matchBrackets: true,
            autoCloseBrackets: true,
            disabled: true,
        });
        outputJsonTextArea.setSize("25vw", "80vh");
        ////////////////////////////////////////////////////////////////////////////////////
        var socket; // VariÃ¡vel global para o objeto WebSocket
        function openWebSocket() {
            socket = new WebSocket("ws://localhost:8080");
            socket.onopen = function () {
                console.log("ðŸŽ‡ ConexÃ£o estabelecida com sucesso!");
                document.getElementById("connectbtn").style.display = "none";
                compileESQl();
            };
            socket.onmessage = function (event) {
                var result = event.data;
                console.log("ðŸ˜ŽðŸ“¥ ESQL recebido:", result)
                renderResponseLog(JSON.parse(result));
            };
            socket.onclose = function (event) {
                document.getElementById('compile-log').innerHTML = "ðŸ’»ðŸ’¤ O servidor provalvelmente esta desligado";
                console.log("ConexÃ£o fechada com cÃ³digo: " + event.code);
                document.getElementById("connectbtn").style.display = "flex";
            };
            socket.onerror = function (error) {
                document.getElementById('compile-log').innerHTML = "ðŸ’»ðŸ”¥ A conexÃ£o do servidor caiu";
                console.error("Erro na conexÃ£o: " + error);
                document.getElementById("connectbtn").style.display = "flex";
            };
        }
        function compileESQl() {
            var esqlCode = esqlTextArea.getValue();
            console.log("ðŸ˜‰ðŸ“¤Enviando ESQL", esqlCode)
            socket.send(esqlCode);
            const responseLogDiv = document.getElementById('compile-log');
            //"Compilando ESQL: ..."
            responseLogDiv.innerHTML =
                `<svg class="pl" width="240" height="240" viewBox="0 0 240 240">
            <circle class="pl__ring pl__ring--a" cx="120" cy="120" r="105" fill="none" stroke="#000" stroke-width="20" stroke-dasharray="0 660" stroke-dashoffset="-330" stroke-linecap="round"></circle>
            <circle class="pl__ring pl__ring--b" cx="120" cy="120" r="35" fill="none" stroke="#000" stroke-width="20" stroke-dasharray="0 220" stroke-dashoffset="-110" stroke-linecap="round"></circle>
            <circle class="pl__ring pl__ring--c" cx="85" cy="120" r="70" fill="none" stroke="#000" stroke-width="20" stroke-dasharray="0 440" stroke-linecap="round"></circle>
            <circle class="pl__ring pl__ring--d" cx="155" cy="120" r="70" fill="none" stroke="#000" stroke-width="20" stroke-dasharray="0 440" stroke-linecap="round"></circle>
            </svg>`;
        }
        function enviarJSON() {
            var jsonData = inputJsonTextArea.getValue();
            var url = 'http://localhost:7800/esql-repl';
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: jsonData
            })
                .then(function (response) {
                    document.getElementById("httpStatusCode").innerText = `Status code: ${response.status}`;
                    return response.json();
                })
                .then(function (data) {
                    console.log('Resposta:', data);
                    outputJsonTextArea.setValue(JSON.stringify(data, null, 2));
                })
                .catch(function (error) {
                    outputJsonTextArea.setValue(`Erro na solicitaÃ§Ã£o: ${error} \nðŸ§ Ã‰ possivel que haja erros de escrita de cÃ³digo`);
                });
        }
        ////////////////////////////////////////////////////////////////////////////////////
        function renderResponseLog(response) {
            const responseLogDiv = document.getElementById('compile-log');
            responseLogDiv.innerHTML = '';
            response.LogEntry.forEach(logEntry => {
                const logEntryDiv = document.createElement('div');
                logEntryDiv.className = 'compile-log';
                logEntryDiv.classList.add(logEntry.message.severityCode === 'E' ? 'error-compile-log' : 'success-compile-log');

                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.textContent = `Message: ${logEntry.message.number}`;
                logEntryDiv.appendChild(messageDiv);

                const textDiv = document.createElement('div');
                textDiv.className = 'text';
                textDiv.textContent = `Text: ${logEntry.text}`;
                logEntryDiv.appendChild(textDiv);

                const detailedTextDiv = document.createElement('div');
                detailedTextDiv.className = 'detailed-text';
                detailedTextDiv.textContent = `Detailed Text: ${logEntry.detailedText}`;
                logEntryDiv.appendChild(detailedTextDiv);

                responseLogDiv.appendChild(logEntryDiv);
            });
        }
    </script>
</body>

</html>