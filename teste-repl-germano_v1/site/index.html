<!DOCTYPE html>
<html>

<head>
    <title>Syntax Highlight SQL</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/theme/darcula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/theme/ayu-mirage.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/hint/sql-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/hint/show-hint.min.js"></script>
</head>

<body>
    <div class="neobrutalism-box">
        <div class="vertical-items">
            ESQL
            <textarea id="sqlTextArea">
    CREATE COMPUTE MODULE main_msgflow_Compute
    CREATE FUNCTION Main() RETURNS BOOLEAN
    BEGIN
        CALL CopyEntireMessage();
        RETURN TRUE;
    END;
    
    CREATE PROCEDURE CopyEntireMessage() BEGIN
        SET OutputRoot = InputRoot;
    END;
    END MODULE;
                </textarea>
            Conex√£o
            <div id="response-log" class="neobrutalism-box"></div>
        </div>
        <div class="vertical-items">
            ENTRADA JSON
            <textarea id="inputJsonTextArea" class="json">{"key": "valueX"}</textarea>
            SAIDA JSON <div id="httpStatusCode">Status code: ___</div>
            <textarea id="outputJsonTextArea" class="json" disabled>{"key": "valueY"}</textarea>
        </div>
        <div class="neobrutalism-box centered-spaced-items">
            <button id="connectbtn" class="bn5" onclick="openWebSocket()">Conectar Servidor</button>
            <button class="bn5" onclick="compileESQl()">Compilar ESQL</button>
            <button class="bn5" onclick="enviarJSON()">Enviar JSON</button>
        </div>
        <div class="image-container"></div>
    </div>

    <script>
        ////////////////////////////////////////////////////////////////////////////////////
        var esqlTextArea = CodeMirror.fromTextArea(
            document.getElementById("sqlTextArea"), {
            mode: "text/x-pgsql",
            theme: "monokai",
            lineNumbers: true,
            matchBrackets: true,
            autoCloseBrackets: true,
            extraKeys: { "Ctrl-Space": "autocomplete" }
        });
        var inputJsonTextArea = CodeMirror.fromTextArea(
            document.getElementById("inputJsonTextArea"), {
            mode: "application/json",
            theme: "darcula",
            lineNumbers: true,
            matchBrackets: true,
            autoCloseBrackets: true,
            extraKeys: { "Ctrl-Space": "autocomplete" }
        });
        var outputJsonTextArea = CodeMirror.fromTextArea(
            document.getElementById("outputJsonTextArea"), {
            mode: "application/json",
            theme: "ayu-mirage",
            lineNumbers: true,
            matchBrackets: true,
            autoCloseBrackets: true,
            disabled: true,
        });
        ////////////////////////////////////////////////////////////////////////////////////
        var socket; // Vari√°vel global para o objeto WebSocket
        function openWebSocket() {
            socket = new WebSocket("ws://localhost:8080");
            socket.onopen = function () {
                console.log("üéá Conex√£o estabelecida com sucesso!");
                document.getElementById("connectbtn").style.display = "none";
                compileESQl();
            };
            socket.onmessage = function (event) {
                var result = event.data;
                console.log("üòéüì• ESQL recebido:", result)
                renderResponseLog(JSON.parse(result));
            };
            socket.onclose = function (event) {
                console.log("Conex√£o fechada com c√≥digo: " + event.code);
                document.getElementById("connectbtn").style.display = "flex";
            };
            socket.onerror = function (error) {
                console.error("Erro na conex√£o: " + error);
                document.getElementById("connectbtn").style.display = "flex";
            };
        }
        function compileESQl() {
            var esqlCode = esqlTextArea.getValue();
            console.log("üòâüì§Enviando ESQL", esqlCode)
            socket.send(esqlCode);
            const responseLogDiv = document.getElementById('response-log');
            responseLogDiv.innerHTML = "Compilando ESQL: ...";
        }
        function enviarJSON() {
            var jsonData = inputJsonTextArea.getValue();
            var url = 'http://localhost:7800/esql-repl';
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: jsonData
            })
                .then(function (response) {
                    document.getElementById("httpStatusCode").innerText = `Status code: ${response.status}`;
                    return response.json();
                })
                .then(function (data) {
                    console.log('Resposta:', data);
                    outputJsonTextArea.setValue(JSON.stringify(data, null, 2));
                })
                .catch(function (error) {
                    outputJsonTextArea.setValue(`Erro na solicita√ß√£o: ${error} \nüßê √â possivel que haja erros de escrita de c√≥digo`);
                });
        }
        ////////////////////////////////////////////////////////////////////////////////////
        function renderResponseLog(response) {
            const responseLogDiv = document.getElementById('response-log');
            responseLogDiv.innerHTML = '';
            response.LogEntry.forEach(logEntry => {
                const logEntryDiv = document.createElement('div');
                logEntryDiv.className = 'log-entry';
                logEntryDiv.classList.add(logEntry.message.severityCode === 'E' ? 'error-log-entry' : 'success-log-entry');

                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.textContent = `Message: ${logEntry.message.number}`;
                logEntryDiv.appendChild(messageDiv);

                const textDiv = document.createElement('div');
                textDiv.className = 'text';
                textDiv.textContent = `Text: ${logEntry.text}`;
                logEntryDiv.appendChild(textDiv);

                const detailedTextDiv = document.createElement('div');
                detailedTextDiv.className = 'detailed-text';
                detailedTextDiv.textContent = `Detailed Text: ${logEntry.detailedText}`;
                logEntryDiv.appendChild(detailedTextDiv);

                responseLogDiv.appendChild(logEntryDiv);
            });
        }
    </script>
</body>

</html>