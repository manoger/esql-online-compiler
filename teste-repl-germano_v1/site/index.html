<!DOCTYPE html>
<html>

<head>
    <title>Syntax Highlight SQL</title>
    <!--Codemirror styles start-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/theme/darcula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/theme/ayu-mirage.min.css">
    <!--Codemirror styles end-->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="loader-colorful-circles.css">
    <link rel="stylesheet" href="loader-glitch-loading.css">
    <link rel="stylesheet" href="layout.css">
    <link rel="stylesheet" href="buttons.css">
    <link rel="stylesheet" href="scrollbar.css">
    <link rel="stylesheet" href="compile-log.css">
    <!--Codemirror scripts start-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/hint/sql-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/hint/show-hint.min.js"></script>
    <!--Codemirror scripts end-->
</head>

<body>  
    <!--section class="horizontal-items">
        <div class="stylized-card horizontal-items">
            <div id="anime-character" class="image-container"></div>
            <textarea id="dialog-box" class="feedback">
                Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
            </textarea>
        </div>
    </section-->

        <section class="horizontal-items">
            <section class="vertical-items ">
                <h1>ENTRADA JSON</h1>
                <textarea id="inputJsonTextArea" class="json">{"key": "valueX"}</textarea>
                <button id="connectbtn" class="bn5" onclick="openWebSocket()">Conectar Servidor</button>
                <!--License: MIT. Made by ShopWare: https://github.com/shopware/meteor-icon-kit-->
                <svg width="50px" height="50px" viewBox="0 0 20 20" id="meteor-icon-kit__solid-server" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M3 14H17C18.6569 14 20 15.3431 20 17C20 18.6569 18.6569 20 17 20H3C1.34315 20 0 18.6569 0 17C0 15.3431 1.34315 14 3 14zM3 16C2.44772 16 2 16.4477 2 17C2 17.5523 2.44772 18 3 18C3.55228 18 4 17.5523 4 17C4 16.4477 3.55228 16 3 16zM3 7H17C18.6569 7 20 8.3431 20 10C20 11.6569 18.6569 13 17 13H3C1.34315 13 0 11.6569 0 10C0 8.3431 1.34315 7 3 7zM3 9C2.44772 9 2 9.4477 2 10C2 10.5523 2.44772 11 3 11C3.55228 11 4 10.5523 4 10C4 9.4477 3.55228 9 3 9zM3 0H17C18.6569 0 20 1.34315 20 3C20 4.65685 18.6569 6 17 6H3C1.34315 6 0 4.65685 0 3C0 1.34315 1.34315 0 3 0zM3 2C2.44772 2 2 2.44772 2 3C2 3.55228 2.44772 4 3 4C3.55228 4 4 3.55228 4 3C4 2.44772 3.55228 2 3 2z" fill="red"/>
                </svg>
                <?xml version="1.0" encoding="utf-8"?>
            </section>
            <section class="vertical-items">
                <h1>ESQL</h1>
                <textarea id="sqlTextArea" class="">
CREATE COMPUTE MODULE main_msgflow_Compute
    CREATE FUNCTION Main() RETURNS BOOLEAN
    BEGIN
        CALL CopyEntireMessage();
        RETURN TRUE;
    END;
    
    CREATE PROCEDURE CopyEntireMessage() BEGIN
        SET OutputRoot = InputRoot;
    END;
END MODULE;
                </textarea>
                <section class=" centered-spaced-items">
                    <button class="bn5" onclick="compileESQl()">Compilar ESQL</button>
                    <button class="bn5" onclick="enviarJSON()">Enviar JSON</button>
                </section>
                <h2>Conexão</h2>
                <div id="compile-log-container" class="stylized-box2">
                    <div class="compile-log-element success-compile-log"> Clique no botão "Compilar"</div>
                    <div class="compile-log-element error-compile-log"> Mas certifique-se de ter subido o servidor 😉 </div>
                </div>
            </section>
            <section class="vertical-items ">
                <h1>SAIDA JSON</h1>
                <textarea id="outputJsonTextArea" class="json" disabled>{"key": "valueY"}</textarea>
                <div id="httpStatusCode">Status code: ___</div>
                <h2>Testes</h2>
                <div id="compile-log-container" class="">
                    <div class="compile-log-element success-compile-log"> Sucesso</div>
                    <div class="compile-log-element error-compile-log"> Falha </div>
                </div>
            </section>
        </section>
    <button class="bn5" onclick="expandESQL()">Expand</button><button class="bn5" onclick="minimizeESQL()">Minimize</button>
    <?xml version="1.0" encoding="utf-8"?>
    <script>
        ////////////////////////////////////////////////////////////////////////////////////
        var esqlTextArea = CodeMirror.fromTextArea(
            document.getElementById("sqlTextArea"), {
            mode: "text/x-pgsql",
            //            theme: "monokai",
            theme: "ayu-mirage",
            lineNumbers: true,
            matchBrackets: true,
            autoCloseBrackets: true,
            extraKeys: { 
                "Ctrl-Space": "autocomplete",
                Tab: function(cm) {
                    var spaces = Array(cm.getOption("indentUnit") + 1).join(" ");
                    cm.replaceSelection(spaces);
                } 
            }
        });
        //esqlTextArea.setSize("100vw","100vh");
        esqlTextArea.setSize("40vw", '80vh');
        var inputJsonTextArea = CodeMirror.fromTextArea(
            document.getElementById("inputJsonTextArea"), {
            mode: "application/json",
            theme: "ayu-mirage",
            lineNumbers: true,
            matchBrackets: true,
            autoCloseBrackets: true,
            extraKeys: { "Ctrl-Space": "autocomplete" }
        });
        inputJsonTextArea.setSize("25vw", "80vh");
        var outputJsonTextArea = CodeMirror.fromTextArea(
            document.getElementById("outputJsonTextArea"), {
            mode: "application/json",
            theme: "ayu-mirage",
            lineNumbers: true,
            matchBrackets: true,
            autoCloseBrackets: true,
            disabled: true,
        });
        outputJsonTextArea.setSize("25vw", "80vh");
        ////////////////////////////////////////////////////////////////////////////////////
        const baseUrl = 'http://localhost:3000'; // Replace with your server URL

        async function startDocker() {
            try {
                const response = await fetch(`${baseUrl}/api/start-docker`, {
                method: 'POST',
                });
                const data = await response.json();
                console.log(data);
                alert(data.message);
            } catch (error) {
                console.error(error);
                alert('Failed to start Docker Compose');
            }
        }

        async function writeAndZipBar() {
            try {
                const message = 'Your plain text message here'; // Replace this with your input message
                const response = await fetch(`${baseUrl}/api/write-zip-bar`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain', // Send the input data as plain text
                },
                body: message,
                });
                const data = await response.json();
                console.log(data);
                alert('API response: ' + JSON.stringify(data));
            } catch (error) {
                console.error(error);
                alert('Error writing and zipping .bar file');
            }
        }

        var socket; // Variável global para o objeto WebSocket
        function openWebSocket() {
            socket = new WebSocket("ws://localhost:8080");
            socket.onopen = function () {
                console.log("🎇 Conexão estabelecida com sucesso!");
                document.getElementById("connectbtn").style.display = "none";
                compileESQl();
            };
            socket.onmessage = function (event) {
                var result = event.data;
                console.log("😎📥 ESQL recebido:", result)
                renderResponseLog(JSON.parse(result));
            };
            socket.onclose = function (event) {
                document.getElementById('compile-log-container').innerHTML = "💻💤 O servidor provalvelmente esta desligado";
                console.log("Conexão fechada com código: " + event.code);
                document.getElementById("connectbtn").style.display = "flex";
            };
            socket.onerror = function (error) {
                document.getElementById('compile-log-container').innerHTML = "💻🔥 A conexão do servidor caiu";
                console.error("Erro na conexão: " + error);
                document.getElementById("connectbtn").style.display = "flex";
            };
        }

        function compileESQl() {
            var esqlCode = esqlTextArea.getValue();
            console.log("😉📤Enviando ESQL", esqlCode)
            socket.send(esqlCode);
            const responseLogDiv = document.getElementById('compile-log-container');
            //"Compilando ESQL: ..."
            responseLogDiv.innerHTML =
                `<svg class="pl" width="240" height="240" viewBox="0 0 240 240">
                <circle class="pl__ring pl__ring--a" cx="120" cy="120" r="105" fill="none" stroke="#000" stroke-width="20" stroke-dasharray="0 660" stroke-dashoffset="-330" stroke-linecap="round"></circle>
                <circle class="pl__ring pl__ring--b" cx="120" cy="120" r="35" fill="none" stroke="#000" stroke-width="20" stroke-dasharray="0 220" stroke-dashoffset="-110" stroke-linecap="round"></circle>
                <circle class="pl__ring pl__ring--c" cx="85" cy="120" r="70" fill="none" stroke="#000" stroke-width="20" stroke-dasharray="0 440" stroke-linecap="round"></circle>
                <circle class="pl__ring pl__ring--d" cx="155" cy="120" r="70" fill="none" stroke="#000" stroke-width="20" stroke-dasharray="0 440" stroke-linecap="round"></circle>
                </svg>`;
        }
        function enviarJSON() {
            var jsonData = inputJsonTextArea.getValue();
            var url = 'http://localhost:7800/esql-repl';
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: jsonData
            })
                .then(function (response) {
                    document.getElementById("httpStatusCode").innerText = `Status code: ${response.status}`;
                    return response.json();
                })
                .then(function (data) {
                    console.log('Resposta:', data);
                    outputJsonTextArea.setValue(JSON.stringify(data, null, 2));
                })
                .catch(function (error) {
                    outputJsonTextArea.setValue(`Erro na solicitação: ${error} \n🧐 É possivel que haja erros de escrita de código`);
                });
        }
        function expandESQL(){
            esqlTextArea.setSize("90vw", '90vh');
            inputJsonTextArea.setSize("90vw", '90vh');
            outputJsonTextArea.setSize("90vw", '90vh');
        }
        function minimizeESQL(){
            esqlTextArea.setSize("40vw", '80vh');
            inputJsonTextArea.setSize("25vw", '80vh');
            outputJsonTextArea.setSize("25vw", '80vh');
        }
        ////////////////////////////////////////////////////////////////////////////////////
        function renderResponseLog(response) {
            const responseLogDiv = document.getElementById('compile-log-container');
            responseLogDiv.innerHTML = '';
            response.LogEntry.forEach(logEntry => {
                const logEntryDiv = document.createElement('div');
                logEntryDiv.className = 'compile-log-element';
                logEntryDiv.classList.add(logEntry.message.severityCode === 'E' ? 'error-compile-log' : 'success-compile-log');
                //
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.textContent = `Message: ${logEntry.message.number}`;
                logEntryDiv.appendChild(messageDiv);
                //
                const textDiv = document.createElement('div');
                textDiv.className = 'text';
                textDiv.textContent = `Text: ${logEntry.text}`;
                logEntryDiv.appendChild(textDiv);
                //
                const detailedTextDiv = document.createElement('div');
                detailedTextDiv.className = 'detailed-text';
                detailedTextDiv.textContent = `Detailed Text: ${logEntry.detailedText}`;
                logEntryDiv.appendChild(detailedTextDiv);
                responseLogDiv.appendChild(logEntryDiv);
            });
        }
    </script>
</body>

</html>